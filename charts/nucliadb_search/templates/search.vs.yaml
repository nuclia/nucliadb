apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: search
spec:
  gateways:
    - "{{ .Values.vs.gateway }}"
  hosts:
    - "{{ .Values.zone }}.{{ .Values.vs.host }}"
  http:
    - name: nucliadb_search
      match:
        - uri:
            regex: '^/api/v\d+/kb/[^/]+/search$'
          method:
            regex: "GET|POST|OPTIONS"
        - uri:
            regex: '^/api/v\d+/kb/[^/]+/find$'
          method:
            regex: "GET|POST|OPTIONS"
        - uri:
            regex: '^/api/v\d+/kb/[^/]+/feedback$'
          method:
            regex: "POST|OPTIONS"
        - uri:
            regex: '^/api/v\d+/kb/[^/]+/catalog$'
          method:
            regex: "GET|POST|OPTIONS"
        - uri:
            regex: '^/api/v\d+/kb/[^/]+/catalog/facets$'
          method:
            regex: "POST|OPTIONS"
        - uri:
            regex: '^/api/v\d+/kb/[^/]+/summarize$'
          method:
            regex: "POST|OPTIONS"
        - uri:
            regex: '^/api/v\d+/kb/[^/]+/(resource|slug)/[^/]+/run-agents$'
          method:
            regex: "POST|OPTIONS"
        - uri:
            regex: '^/api/v\d+/kb/[^/]+/predict/.*'
          method:
            regex: "GET|POST|OPTIONS"
        - uri:
            regex: '^/api/v\d+/kb/[^/]+/(resource|slug)/[^/]+/(find|search)$'
          method:
            regex: "GET|POST|OPTIONS"
        - uri:
            regex: '^/api/v\d+/kb/[^/]+/counters'
          method:
            regex: "GET|OPTIONS"
        - uri:
            regex: '^/api/v\d+/kb/[^/]+/suggest'
          method:
            regex: "GET|OPTIONS"
        - uri:
            regex: '^/api/v\d+/kb/[^/]+/graph'
          method:
            regex: "POST|OPTIONS"
        - uri:
            regex: '^/api/v\d+/kb/[^/]+/graph/nodes'
          method:
            regex: "POST|OPTIONS"
        - uri:
            regex: '^/api/v\d+/kb/[^/]+/graph/relations'
          method:
            regex: "POST|OPTIONS"
        - uri:
            regex: '^/api/v\d+/kb/[^/]+/hydrate'
          method:
            regex: "POST|OPTIONS"
      retries:
        attempts: 3
        retryOn: connect-failure
      route:
        - destination:
            port:
              number: {{.Values.serving.port}}
            host: "search.{{ .Release.Namespace }}.svc.cluster.local"

{{- if .Values.ask_canary.rao_kbid_regex }}
    # Canary release (traffic shifting) for /ask endpoints by specified kbids
    - name: nucliadb_search_canary_by_kbid
      match:
        - uri:
            regex: '^/api/v\d+/kb/{{ .Values.ask_canary.rao_kbid_regex }}/ask$'
          method:
            regex: "POST|OPTIONS"
        - uri:
            regex: '^/api/v\d+/kb/{{ .Values.ask_canary.rao_kbid_regex }}/(resource|slug)/[^/]+/ask$'
          method:
            regex: "POST|OPTIONS"
      route:
        - destination:
            host: "arag-api.arag.svc.cluster.local"
            port:
              number: {{ .Values.ask_canary.rao_serving_port }}
      retries:
        attempts: 3
        retryOn: connect-failure,5xx
{{- end }}

    # Generic canary release (traffic shifting) for /ask endpoints
    - name: nucliadb_search_canary
      match:
        - uri:
            regex: '^/api/v\d+/kb/[^/]+/ask$'
          method:
            regex: "POST|OPTIONS"
        - uri:
            regex: '^/api/v\d+/kb/[^/]+/(resource|slug)/[^/]+/ask$'
          method:
            regex: "POST|OPTIONS"
      route:
        - destination:
            host: "search.{{ .Release.Namespace }}.svc.cluster.local"
            port:
              number: {{ .Values.serving.port }}
          weight: {{ .Values.ask_canary.nucliadb_weight | default 100 }}
        - destination:
            host: "arag-api.arag.svc.cluster.local"
            port:
              number: {{ .Values.ask_canary.rao_serving_port }}
          weight: {{ .Values.ask_canary.rao_weight | default 0 }}
      retries:
        attempts: 3
        retryOn: connect-failure,5xx

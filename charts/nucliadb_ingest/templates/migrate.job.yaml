apiVersion: batch/v1
kind: Job
metadata:
  name: migrate-job
  labels:
    app: migrate-job
    version: "{{ .Chart.Version | replace "+" "_" }}"
    chart: "{{ .Chart.Name }}"
    release: "{{ .Release.Name }}"
    heritage: "{{ .Release.Service }}"
  annotations:
    "helm.sh/hook": post-install
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: migrate-job
          image: "{{ .Values.containerRegistry }}/{{ .Values.image }}"
          imagePullPolicy: {{.Values.imagePullPolicy}}
          command: ["nucliadb-migrate"]
          envFrom:
          - configMapRef:
              name: nucliadb-config
          - configMapRef:
              name: {{ .Release.Name }}-config
          env:
            - name: VERSION
              valueFrom:
                fieldRef:
                  fieldPath: metadata.labels['version']
          {{- range $key, $value := .Values.env }}
            - name: "{{ $key }}"
              value: {{ tpl $value $ | toJson }}
          {{- end }}
          resources:
  {{ toYaml .Values.ingest_orm_grpc_resources | indent 10 }}
  {{- if .Values.nats.secretName }}
          volumeMounts:
            - name: nats-creds
              readOnly: true
              mountPath: /appsecrets
  {{- end }}
  {{- if .Values.nats.regionalSecretName }}
            - name: regional-nats-creds
              readOnly: true
              mountPath: /regioncreds
  backoffLimit: 3
